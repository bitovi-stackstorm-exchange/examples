version: 1.0

description: Receiver for 2FA inquiries 

input:
  - inquiry_data

tasks:
  
  fetch_secret_key:
    action: mockvault.get-secret
    input:
      type: <% ctx().inquiry_data.route %>
    next:
      - when: <% succeeded() %>
        do: fetch_secret

  fetch_secret:
    action: st2.kv.get
    input:
      key: <% task(fetch_secret_key).result.output.kv_name %>
    next:
      - when: <% succeeded() %>
        do: respond

  respond:
    action: core.local
    input:
      cmd: "st2 inquiry respond -r '{\"token\": \"<% task(fetch_secret).stdout %>\"}' <% ctx().inquiry_data.id %>"

