version: 1.0

description: higher-level workflow that allows retries for a provided action

input:
  - action
  - max_retries

vars:
  - retries: 0

tasks:
  call_action:
    action: <% ctx().action %>
    next:
      - when: <% succeeded() %>
        do: finish
      # - when: <% failed() %>
      #   do: try_again
      - when: <% failed() and ctx().retries < ctx().max_retries %>
        publish:
          # - retries: <% ctx().retries + 1 %>
          - retries: 3
        do: try_again
      - when: <% failed() and ctx().retries >= ctx().max_retries %>
        do: stop

  try_again:
    action: core.noop
    next:
      - when: <% succeeded() %>
        do: call_action

  # try_again:
  #   action: core.echo message="try again"

  finish:
    action: core.echo message="Retry succeeded"

  stop:
    action: core.echo message="Exceeded retries"
    next:
      - do: fail